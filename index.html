
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Jai Ambey Logistics Service — LR Admin (Draft)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Theme & Layout -->
<style>
  :root{
    --brand:#123f6b; --brand-dark:#0e2f51; --accent:#f0f4fa; --ink:#18202a;
    --border:#d6dbe3; --danger:#d62828; --ok:#2e7d32; --warn:#f59f00;
    --mm-border: #000; --mm-line: .3mm;
    --card-radius: 12px;
    --sheet-w: 297mm; --sheet-h: 210mm;
  }
  @page { size: A4 landscape; margin: 8mm; }
  @media print { 
    header, .app-grid .left, .toolbar, .list-card, .manage-modal { display:none !important; }
    .sheet-wrap { box-shadow:none !important; }
  }

  /* App shell */
  body{margin:0;background:#fbfdff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{
    position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),var(--brand-dark));
    color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;
  }
  header .logo{
    width:36px;height:36px;border-radius:6px;background:#fff1;display:grid;place-items:center;border:1px solid #fff3;
  }
  header .title{font-weight:700;letter-spacing:.3px}
  header .sub{opacity:.9;font-size:12px}
  .toolbar{margin-left:auto;display:flex;gap:8px}
  .toolbar button{
    background:#ffffff22;border:1px solid #ffffff44;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;
  }
  .toolbar button:hover{background:#ffffff33}

  .app-grid{display:grid;grid-template-columns: 420px 1fr; gap:16px; padding:16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--card-radius);box-shadow:0 2px 8px rgba(16,24,40,.06)}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px}
  .card-body{padding:12px 14px}

  /* Form */
  .form .row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .form label{font-size:12px;color:#3a4757}
  .form input,.form select,.form textarea{
    padding:8px 10px;border:1px solid #cfd6e4;border-radius:8px;font-size:14px;background:#fff;
  }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .grid-6{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #cfd6e4;background:#f6f8fc;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.warn{background:#fff7e6;border-color:#ffd590;color:#8a4b00}
  .btn.danger{background:#fff0f0;border-color:#ffc3c3;color:#9b1c1c}
  .micro{display:flex;align-items:center;gap:6px}
  .micro .add{cursor:pointer;color:var(--brand);font-size:12px}
  .inline-note{font-size:11px;color:#6b7787}

  /* Sheet preview (A4 landscape, mm-precise) */
  .sheet-wrap{padding:12px;display:flex;justify-content:center}
  .lr-sheet{
    width:var(--sheet-w); height:var(--sheet-h); background:#fff; border:.4mm solid var(--mm-border);
    box-shadow:0 8px 28px rgba(0,0,0,.07); padding:6mm; font-size:12px;
  }
  .lr-head{display:grid;grid-template-columns:1fr 90mm; gap:2mm; border-bottom:var(--mm-line) solid var(--mm-border); padding-bottom:2mm}
  .lr-brand .title{font-size:17px;font-weight:800}
  .lr-brand .subtitle{font-weight:600;margin-top:1mm}
  .lr-brand .addr,.lr-brand .contact,.lr-brand .tax{margin-top:1mm}
  .lr-markers{text-align:right}
  .lr-markers .badge{display:inline-block;border:var(--mm-line) solid var(--mm-border);padding:1.2mm 2mm;margin-left:1.5mm;font-weight:700}
  .lr-top,.lr-route,.lr-invoice,.lr-insurance,.lr-pack,.lr-descw,.lr-freight{display:grid;gap:2mm;margin-top:2mm}
  .lr-top{grid-template-columns:1fr 1fr}
  .lr-route{grid-template-columns:repeat(3,1fr)}
  .lr-invoice{grid-template-columns:repeat(3,1fr)}
  .lr-insurance{grid-template-columns:repeat(6,1fr)}
  .lr-pack{grid-template-columns:1fr}
  .lr-descw{grid-template-columns:2fr 1fr 1fr}
  .lr-freight{grid-template-columns:repeat(6,1fr)}
  .box{border:var(--mm-line) solid var(--mm-border); padding:1.4mm; min-height:10mm; display:flex; flex-direction:column}
  .box.block{min-height:18mm}
  .box > span{color:#3f4a58;font-size:11px}
  .box > strong{margin-top:.6mm}
  .multiline{white-space:pre-wrap;line-height:1.3}
  .lr-notices{display:grid;grid-template-columns:1fr 1fr;gap:2mm;margin-top:2mm}
  .lr-notices .n{border:var(--mm-line) solid var(--mm-border);padding:1.4mm;min-height:18mm}
  .lr-notices .n strong{display:block;margin-bottom:1mm}
  .lr-disclaimer{margin-top:2mm;border:var(--mm-line) solid var(--mm-border);padding:1.4mm;text-align:center;font-weight:600}
  .lr-sign{display:grid;grid-template-columns:1fr 1fr;gap:2mm;margin-top:2mm}
  .sig{border:var(--mm-line) solid var(--mm-border);padding:1.4mm}
  .sig .line{margin-top:8mm;border-top:var(--mm-line) dashed #333;height:0}
  .lr-foot{display:flex;justify-content:space-between;align-items:center;margin-top:2mm;border-top:var(--mm-line) solid var(--mm-border);padding-top:1.5mm}
  #qrCanvas{display:none;border:1px solid #eee}

  /* List of saved LRs */
  .list-card table{width:100%;border-collapse:collapse;font-size:13px}
  .list-card th,.list-card td{border:1px solid var(--border);padding:6px}
  .list-card th{background:var(--accent);text-align:left}

  /* Manage defaults modal */
  .manage-modal{position:fixed;inset:0;background:rgba(16,24,40,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .manage-modal .panel{width:min(720px,90vw);background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 40px rgba(16,24,40,.24)}
  .panel h4{margin:0;padding:12px 14px;border-bottom:1px solid var(--border)}
  .panel .body{padding:12px 14px}
  .panel .row{display:grid;grid-template-columns: 180px 1fr 100px;gap:8px;align-items:center;margin-bottom:8px}
  .panel .items{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#eef3fb;border:1px solid #d6e2ff;color:#21406f;padding:3px 8px;border-radius:999px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .chip .x{cursor:pointer;color:#6b7787}
  .panel .btns{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
  @media (max-width: 1024px) { .app-grid{grid-template-columns:1fr} .sheet-wrap{overflow-x:auto} }
</style>

<!-- A4 print -->
<style>
  /* Print only the LR sheet */
  @media print {
    .lr-sheet{page-break-inside:avoid}
  }
</style>
</head>

<body>
  <!-- Top Bar -->
  <header>
    <div class="logo" aria-hidden="true">
      <!-- inline truck icon -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="#fff"><path d="M3 6h11v8H3zM14 9h4l3 3v2h-7zM5 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm10 0a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
    </div>
    <div>
      <div class="title">JAI AMBEY LOGISTICS SERVICE</div>
      <div class="sub">Fleet Owner & Transport Contractor</div>
    </div>
    <div class="toolbar">
      <button id="btnManage">Manage defaults</button>
      <button id="btnExportJSON">Export JSON</button>
      <button id="btnExportCSV">Export CSV</button>
      <button id="btnPrint">Print</button>
    </div>
  </header>

  <!-- Main -->
  <div class="app-grid">
    <!-- Left: Form -->
    <div class="left card form">
      <h3>Create / Edit LR</h3>
      <div class="card-body">
        <div class="grid-2">
          <div class="row">
            <label>CN NOTE NO. (LR No.)</label>
            <div class="micro">
              <input id="lr_no" placeholder="Auto if blank (YYYYMMDD-###)" />
              <span class="inline-note">Auto when saved</span>
            </div>
          </div>
          <div class="row">
            <label>Date</label>
            <input type="date" id="date" />
          </div>
        </div>

        <div class="grid-2">
          <div class="row">
            <label>Consignor’s name & address</label>
            <textarea id="consignor" rows="3" placeholder="Name&#10;Address"></textarea>
          </div>
          <div class="row">
            <label>Consignee’s name & address</label>
            <textarea id="consignee" rows="3" placeholder="Name&#10;Address"></textarea>
          </div>
        </div>

        <div class="grid-3">
          <div class="row">
            <label>From</label>
            <div class="micro">
              <input list="places" id="from_place" />
              <span class="add" data-target="places">＋ Add</span>
            </div>
          </div>
          <div class="row">
            <label>To</label>
            <div class="micro">
              <input list="places" id="to_place" />
              <span class="add" data-target="places">＋ Add</span>
            </div>
          </div>
          <div class="row">
            <label>Sales Tax Permit No.</label>
            <input id="stp_no" />
          </div>
        </div>

        <div class="grid-3">
          <div class="row">
            <label>Invoice No.</label>
            <input id="invoice_no" />
          </div>
          <div class="row">
            <label>Invoice Date</label>
            <input type="date" id="invoice_date" />
          </div>
          <div class="row">
            <label>Service Tax Payable by</label>
            <select id="service_tax_payable_by"></select>
          </div>
        </div>

        <fieldset style="border:1px dashed #cfd6e4;border-radius:8px;padding:8px;margin-bottom:10px">
          <legend style="font-size:12px">Insurance</legend>
          <div class="grid-6">
            <div class="row">
              <label>Status</label>
              <select id="insurance_status"></select>
            </div>
            <div class="row">
              <label>Company</label>
              <input id="insurance_company" />
            </div>
            <div class="row">
              <label>Policy No.</label>
              <input id="insurance_policy_no" />
            </div>
            <div class="row">
              <label>Amount (₹)</label>
              <input type="number" step="0.01" id="insurance_amount" />
            </div>
            <div class="row">
              <label>Risk</label>
              <input id="insurance_risk" placeholder="e.g., Owner Risk" />
            </div>
            <div class="row">
              <label>Date</label>
              <input type="date" id="insurance_date" />
            </div>
          </div>
        </fieldset>

        <div class="row">
          <label>Packing / PKG. / QTY / Material Type</label>
          <textarea id="packing_details" rows="2"></textarea>
        </div>

        <div class="grid-3">
          <div class="row">
            <label>Description (said to contain)</label>
            <textarea id="description" rows="2"></textarea>
          </div>
          <div class="row">
            <label>Actual Weight</label>
            <input type="number" step="0.01" id="actual_weight" />
          </div>
          <div class="row">
            <label>Wt. Unit</label>
            <select id="weight_unit"></select>
          </div>
        </div>

        <fieldset style="border:1px dashed #cfd6e4;border-radius:8px;padding:8px;margin-bottom:10px">
          <legend style="font-size:12px">Freight</legend>
          <div class="grid-6">
            <div class="row">
              <label>Status</label>
              <select id="freight_status"></select>
            </div>
            <div class="row">
              <label>Vehicle Type</label>
              <div class="micro">
                <input list="vehicleTypes" id="vehicle_type" />
                <span class="add" data-target="vehicleTypes">＋ Add</span>
              </div>
            </div>
            <div class="row">
              <label>Charges (₹)</label>
              <input type="number" step="0.01" id="charges" />
            </div>
            <div class="row">
              <label>Remarks</label>
              <input id="remarks" />
            </div>
            <div class="row">
              <label>Value (₹)</label>
              <input type="number" step="0.01" id="value" />
            </div>
            <div class="row">
              <label>Vehicle No.</label>
              <input id="vehicle_no" />
            </div>
          </div>
        </fieldset>

        <div class="grid-2">
          <div class="row">
            <label>Copy Type</label>
            <select id="copy_type"></select>
          </div>
          <div class="row">
            <label>QR Code</label>
            <select id="qr_enable">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn" id="btnNew">New LR</button>
          <button class="btn primary" id="btnSave">Save</button>
          <button class="btn" id="btnPreview">Update Preview</button>
          <button class="btn" id="btnPrint2">Print</button>
          <button class="btn danger" id="btnDelete">Delete</button>
        </div>

        <!-- Datalists -->
        <datalist id="places"></datalist>
        <datalist id="vehicleTypes"></datalist>
      </div>
    </div>

    <!-- Right: Preview & List -->
    <div class="right">
      <div class="card">
        <h3>Live Preview (A4 landscape)</h3>
        <div class="card-body sheet-wrap">
          <div class="lr-sheet" id="lrSheet">
            <div class="lr-head">
              <div class="lr-brand">
                <div class="title">JAI AMBEY LOGISTICS SERVICE</div>
                <div class="subtitle">FLEET OWNER &amp; TRANSPORT CONTRACTOR</div>
                <div class="addr">
                  Ground Floor, No.33, Dasanapura Hobli, Tumakur Road, 1st Main, Madanayakanahalli Village,
                  Near Shivaganga Hospital, Bengaluru Urban, Karnataka, 562162
                </div>
                <div class="contact">
                  E-Mail: jaiambey.logisticsservice@gmail.com &nbsp;&nbsp; Mob: 8951746209, 9513240005
                </div>
                <div class="tax">
                  PAN: ANOPR7138P &nbsp;&nbsp; GSTIN: 29ANOPR7138P2ZS
                </div>
              </div>
              <div class="lr-markers">
                <div class="badge" id="markerCopy">CONSIGNEE COPY</div>
                <div class="badge">AT OWNER’S RISK</div>
              </div>
            </div>

            <div class="lr-top">
              <div class="box"><span>CN NOTE NO.</span><strong id="prev_lr_no"></strong></div>
              <div class="box"><span>Date</span><strong id="prev_date"></strong></div>
            </div>

            <div class="lr-route">
              <div class="box block"><span>Consignor’s Name &amp; Address</span><div id="prev_consignor" class="multiline"></div></div>
              <div class="box block"><span>Consignee’s Name &amp; Address</span><div id="prev_consignee" class="multiline"></div></div>
              <div class="box"><span>Sales Tax Permit No.</span><strong id="prev_stp"></strong></div>
            </div>

            <div class="lr-invoice">
              <div class="box"><span>From</span><strong id="prev_from"></strong></div>
              <div class="box"><span>To</span><strong id="prev_to"></strong></div>
              <div class="box"><span>Invoice No / Date</span><strong id="prev_invoice"></strong></div>
            </div>

            <div class="lr-invoice">
              <div class="box"><span>Service Tax Payable by</span><strong id="prev_stpb"></strong></div>
              <div class="box"><span>Copy Type</span><strong id="prev_copy"></strong></div>
              <div class="box"><span>QR</span><canvas id="qrCanvas" width="80" height="80" style="display:none"></canvas></div>
            </div>

            <div class="lr-insurance">
              <div class="box"><span>Insurance</span><strong id="prev_ins_status"></strong></div>
              <div class="box"><span>Company</span><strong id="prev_ins_company"></strong></div>
              <div class="box"><span>Policy No.</span><strong id="prev_ins_policy"></strong></div>
              <div class="box"><span>Amount (₹)</span><strong id="prev_ins_amount"></strong></div>
              <div class="box"><span>Risk</span><strong id="prev_ins_risk"></strong></div>
              <div class="box"><span>Date</span><strong id="prev_ins_date"></strong></div>
            </div>

            <div class="lr-pack">
              <div class="box block"><span>Packing / PKG. / QTY / Material Type</span><div id="prev_pack" class="multiline"></div></div>
            </div>

            <div class="lr-descw">
              <div class="box block"><span>Description (said to contain)</span><div id="prev_desc" class="multiline"></div></div>
              <div class="box"><span>Actual Weight</span><strong id="prev_weight"></strong></div>
              <div class="box"><span>Wt.</span><strong id="prev_weight_unit"></strong></div>
            </div>

            <div class="lr-freight">
              <div class="box"><span>Freight</span><strong id="prev_freight"></strong></div>
              <div class="box"><span>Vehicle Type</span><strong id="prev_vehicle_type"></strong></div>
              <div class="box"><span>Charges (₹)</span><strong id="prev_charges"></strong></div>
              <div class="box"><span>Remarks</span><strong id="prev_remarks"></strong></div>
              <div class="box"><span>Value (₹)</span><strong id="prev_value"></strong></div>
              <div class="box"><span>Vehicle No.</span><strong id="prev_vehicle_no"></strong></div>
            </div>

            <div class="lr-notices">
              <div class="n"><strong>CAUTION!</strong>
                <div>This consignment will not be detained, diverted, re‑routed or re‑booked without Consignee’s / Bank’s written permission and will be delivered only at the destination.</div>
              </div>
              <div class="n"><strong>NOTICE</strong>
                <div>The consignment covered by this Lorry Receipt shall be stored at destination under the control of the Transport Operator and delivered only to or to the order of the Consignee Bank. No delivery without written authority endorsed on the Consignee Copy or a separate Letter of Authority.</div>
              </div>
            </div>

            <div class="lr-disclaimer">Carriers are not responsible for leakage &amp; breakage &amp; damage</div>

            <div class="lr-sign">
              <div class="sig"><span>Issued By (Authorized Signatory)</span><div class="line"></div></div>
              <div class="sig"><span>Driver / Receiver (Signature &amp; Stamp)</span><div class="line"></div></div>
            </div>

            <div class="lr-foot">
              <div><strong>For JAI AMBEY LOGISTICS SERVICE</strong></div>
              <div>PAN: ANOPR7138P &nbsp;&nbsp; GSTIN: 29ANOPR7138P2ZS</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Saved LRs -->
      <div class="card list-card">
        <h3>Saved LRs (local)</h3>
        <div class="card-body">
          <table id="lrTable">
            <thead>
              <tr>
                <th>ID</th><th>LR No</th><th>Date</th><th>From → To</th><th>Vehicle</th><th>Freight</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage defaults / dropdown items -->
  <div class="manage-modal" id="manageModal" aria-hidden="true">
    <div class="panel">
      <h4>Manage defaults & dropdown items</h4>
      <div class="body" id="manageBody">
        <!-- Rows are injected by JS -->
      </div>
      <div class="btns">
        <button class="btn" id="closeManage">Close</button>
        <button class="btn primary" id="saveManage">Save</button>
      </div>
    </div>
  </div>

  <!-- QR library (CDN). If offline, QR will simply hide. -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
/* ========= Simple, professional LR admin (no backend) =========
   Data model, lists, and CRUD are all client-side via localStorage.
   The A4 LR preview matches the book layout and prints pixel-accurate.
=============================================================== */

// ----- Storage helpers -----
const store = {
  get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; } },
  set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
};

// ----- Dropdown lists (editable) -----
const LISTS_KEY = 'jaiambey_lists_v1';
const DEFAULT_LISTS = {
  places: ['Bengaluru','Tumakuru','Mysuru','Hubballi'],
  vehicleTypes: ['Open Truck','Container','Trailer','LCV'],
  service_tax_payable_by: ['Consignee','Consignor','Transporter'],
  insurance_status: ['Not Insured','Insured'],
  weight_unit: ['kg','tonne','g'],
  freight_status: ['TBB','PAID','TO PAY'],
  copy_type: ['Consignee','Carrier','Accounts','Office']
};
let Lists = store.get(LISTS_KEY, DEFAULT_LISTS);

// ----- Defaults for frequently used fields -----
const DEFAULTS_KEY = 'jaiambey_defaults_v1';
let Defaults = store.get(DEFAULTS_KEY, {
  from_place: 'Bengaluru',
  to_place: 'Tumakuru',
  service_tax_payable_by: 'Consignee',
  insurance_status: 'Not Insured',
  weight_unit: 'kg',
  freight_status: 'TBB',
  vehicle_type: 'Open Truck',
  copy_type: 'Consignee'
});

// ----- LRs (local records) -----
const LRS_KEY = 'jaiambey_lrs_v1';
let LRs = store.get(LRS_KEY, []); // array of LR objects
let currentId = null;

// ----- Elements -----
const $ = (id) => document.getElementById(id);
const setText = (id, v) => ($(id).textContent = v ?? '');
const setHTML = (id, v) => ($(id).innerHTML = v ?? '');
const currencyINR = (n) => (n===undefined||n===''||n===null) ? '' :
  Number(n).toLocaleString('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:2});

// ----- Populate selects & datalists -----
function renderLists(){
  // Datalists
  const placesDL = $('places'); placesDL.innerHTML = '';
  Lists.places.forEach(p => placesDL.insertAdjacentHTML('beforeend', `<option value="${escapeHTML(p)}"></option>`));

  const vTypesDL = $('vehicleTypes'); vTypesDL.innerHTML = '';
  Lists.vehicleTypes.forEach(v => vTypesDL.insertAdjacentHTML('beforeend', `<option value="${escapeHTML(v)}"></option>`));

  // Selects
  fillSelect('service_tax_payable_by', Lists.service_tax_payable_by, Defaults.service_tax_payable_by);
  fillSelect('insurance_status', Lists.insurance_status, Defaults.insurance_status);
  fillSelect('weight_unit', Lists.weight_unit, Defaults.weight_unit);
  fillSelect('freight_status', Lists.freight_status, Defaults.freight_status);
  fillSelect('copy_type', Lists.copy_type, Defaults.copy_type);
}
function fillSelect(id, items, defaultVal){
  const sel = $(id); sel.innerHTML = items.map(x => `<option>${escapeHTML(x)}</option>`).join('');
  sel.value = items.includes(defaultVal) ? defaultVal : items[0];
}
function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// ----- Prefill defaults -----
function applyDefaults(){
  setVal('from_place', Defaults.from_place);
  setVal('to_place', Defaults.to_place);
  $('service_tax_payable_by').value = Defaults.service_tax_payable_by;
  $('insurance_status').value = Defaults.insurance_status;
  $('weight_unit').value = Defaults.weight_unit;
  $('freight_status').value = Defaults.freight_status;
  setVal('vehicle_type', Defaults.vehicle_type);
  $('copy_type').value = Defaults.copy_type;
}
function setVal(id, v){ $(id).value = v ?? ''; }

// ----- Auto LR number generator -----
function nextLRNumber(dateStr){
  const datePart = (dateStr || new Date().toISOString().slice(0,10)).replace(/-/g,''); // YYYYMMDD
  const sameDate = LRs.filter(r => r.date === (dateStr || new Date().toISOString().slice(0,10)));
  const seq = sameDate.reduce((max, r) => {
    const m = (r.lr_no||'').match(/-(\d{3})$/);
    const n = m ? parseInt(m[1],10) : 0;
    return Math.max(max, n);
  }, 0) + 1;
  return `${datePart}-${String(seq).padStart(3,'0')}`;
}

// ----- Gather form -----
function formData(){
  return {
    lr_no: $('lr_no').value.trim(),
    date: $('date').value || new Date().toISOString().slice(0,10),
    consignor_name: $('consignor').value.split('\n')[0] || '',
    consignor_address: $('consignor').value,
    consignee_name: $('consignee').value.split('\n')[0] || '',
    consignee_address: $('consignee').value,
    from_place: $('from_place').value,
    to_place: $('to_place').value,
    sales_tax_permit_no: $('stp_no').value,
    invoice_no: $('invoice_no').value,
    invoice_date: $('invoice_date').value,
    service_tax_payable_by: $('service_tax_payable_by').value,
    insurance_status: $('insurance_status').value,
    insurance_company: $('insurance_company').value,
    insurance_policy_no: $('insurance_policy_no').value,
    insurance_amount: $('insurance_amount').value || null,
    insurance_risk: $('insurance_risk').value,
    insurance_date: $('insurance_date').value,
    packing_details: $('packing_details').value,
    description: $('description').value,
    actual_weight: $('actual_weight').value || null,
    weight_unit: $('weight_unit').value,
    freight_status: $('freight_status').value,
    vehicle_type: $('vehicle_type').value,
    charges: $('charges').value || null,
    remarks: $('remarks').value,
    value: $('value').value || null,
    vehicle_no: $('vehicle_no').value,
    copy_type: $('copy_type').value,
    created_at: new Date().toISOString()
  };
}

// ----- Save / Update / Delete -----
function saveLR(){
  let data = formData();
  if(!data.lr_no){ data.lr_no = nextLRNumber(data.date); $('lr_no').value = data.lr_no; }

  if(currentId){
    const idx = LRs.findIndex(r => r.id === currentId);
    if(idx>=0){ LRs[idx] = { ...LRs[idx], ...data }; }
  }else{
    const nextId = (LRs[LRs.length-1]?.id || 0) + 1;
    LRs.push({ id: nextId, ...data });
    currentId = nextId;
  }
  store.set(LRS_KEY, LRs);
  renderTable();
  updatePreview();
  toast('Saved');
}
function newLR(){
  currentId = null;
  ['lr_no','date','consignor','consignee','from_place','to_place','stp_no','invoice_no','invoice_date',
   'insurance_company','insurance_policy_no','insurance_amount','insurance_risk','insurance_date','packing_details',
   'description','actual_weight','vehicle_type','charges','remarks','value','vehicle_no'].forEach(id => setVal(id,''));
  applyDefaults();
  updatePreview();
}
function deleteLR(){
  if(!currentId){ toast('No LR selected'); return; }
  LRs = LRs.filter(r => r.id !== currentId);
  store.set(LRS_KEY, LRs);
  currentId = null;
  renderTable();
  newLR();
  toast('Deleted');
}

// ----- List table -----
function renderTable(){
  const tbody = $('lrTable').querySelector('tbody');
  tbody.innerHTML = '';
  LRs.slice().reverse().forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${escapeHTML(r.lr_no)}</td>
      <td>${escapeHTML(r.date)}</td>
      <td>${escapeHTML(r.from_place||'')} → ${escapeHTML(r.to_place||'')}</td>
      <td>${escapeHTML(r.vehicle_no||'')}</td>
      <td>${escapeHTML(r.freight_status||'')}</td>
      <td>
        <button class="btn" data-act="edit" data-id="${r.id}">Edit</button>
        <button class="btn danger" data-act="del" data-id="${r.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', (e)=>{
      const id = Number(btn.dataset.id);
      const act = btn.dataset.act;
      if(act==='edit'){
        const r = LRs.find(x=>x.id===id);
        if(!r) return;
        currentId = id;
        // fill form
        setVal('lr_no', r.lr_no);
        setVal('date', r.date);
        setVal('consignor', [r.consignor_name, r.consignor_address].filter(Boolean).join('\n'));
        setVal('consignee', [r.consignee_name, r.consignee_address].filter(Boolean).join('\n'));
        setVal('from_place', r.from_place);
        setVal('to_place', r.to_place);
        setVal('stp_no', r.sales_tax_permit_no);
        setVal('invoice_no', r.invoice_no);
        setVal('invoice_date', r.invoice_date);
        $('service_tax_payable_by').value = r.service_tax_payable_by;
        $('insurance_status').value = r.insurance_status;
        setVal('insurance_company', r.insurance_company);
        setVal('insurance_policy_no', r.insurance_policy_no);
        setVal('insurance_amount', r.insurance_amount);
        setVal('insurance_risk', r.insurance_risk);
        setVal('insurance_date', r.insurance_date);
        setVal('packing_details', r.packing_details);
        setVal('description', r.description);
        setVal('actual_weight', r.actual_weight);
        $('weight_unit').value = r.weight_unit;
        $('freight_status').value = r.freight_status;
        setVal('vehicle_type', r.vehicle_type);
        setVal('charges', r.charges);
        setVal('remarks', r.remarks);
        setVal('value', r.value);
        setVal('vehicle_no', r.vehicle_no);
        $('copy_type').value = r.copy_type;
        updatePreview();
        window.scrollTo({ top: 0, behavior:'smooth' });
      }else if(act==='del'){
        if(confirm('Delete this LR?')){ currentId = id; deleteLR(); }
      }
    });
  });
}

// ----- Preview -----
function updatePreview(){
  const d = formData();
  setText('prev_lr_no', d.lr_no || '(auto on save)');
  setText('prev_date', d.date);
  setHTML('prev_consignor', (d.consignor_address||'').replace(/\n/g,'<br/>'));
  setHTML('prev_consignee', (d.consignee_address||'').replace(/\n/g,'<br/>'));
  setText('prev_stp', d.sales_tax_permit_no);
  setText('prev_from', d.from_place);
  setText('prev_to', d.to_place);
  setText('prev_invoice', [d.invoice_no, d.invoice_date].filter(Boolean).join(' / '));
  setText('prev_stpb', d.service_tax_payable_by);
  setText('prev_copy', d.copy_type);
  setText('prev_ins_status', d.insurance_status);
  setText('prev_ins_company', d.insurance_company);
  setText('prev_ins_policy', d.insurance_policy_no);
  setText('prev_ins_amount', d.insurance_amount ? currencyINR(d.insurance_amount) : '');
  setText('prev_ins_risk', d.insurance_risk);
  setText('prev_ins_date', d.insurance_date);
  setHTML('prev_pack', (d.packing_details||'').replace(/\n/g,'<br/>'));
  setHTML('prev_desc', (d.description||'').replace(/\n/g,'<br/>'));
  setText('prev_weight', d.actual_weight);
  setText('prev_weight_unit', d.weight_unit);
  setText('prev_freight', d.freight_status);
  setText('prev_vehicle_type', d.vehicle_type);
  setText('prev_charges', d.charges ? currencyINR(d.charges) : '');
  setText('prev_remarks', d.remarks);
  setText('prev_value', d.value ? currencyINR(d.value) : '');
  setText('prev_vehicle_no', d.vehicle_no);
  $('markerCopy').textContent = (d.copy_type || 'Consignee').toUpperCase() + ' COPY';

  // QR
  const canvas = $('qrCanvas');
  if($('qr_enable').value === 'yes' && window.QRCode){
    const payload = { lr_no: d.lr_no || '(auto)', date: d.date, route: `${d.from_place}→${d.to_place}`, vehicle_no: d.vehicle_no };
    QRCode.toCanvas(canvas, JSON.stringify(payload), { width: 80 }, (err)=>{ if(!err) canvas.style.display = 'block'; });
  }else{
    canvas.style.display = 'none';
  }
}

// ----- Export -----
$('btnExportJSON').addEventListener('click', ()=> downloadJSON(LRs, 'lrs.json'));
$('btnExportCSV').addEventListener('click', ()=> downloadCSV(LRs, 'lrs.csv'));
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  triggerDownload(blob, filename);
}
function downloadCSV(rows, filename){
  if(!rows.length){ toast('No data to export'); return; }
  const cols = Object.keys(rows[0]);
  const header = cols.join(',');
  const body = rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(',')).join('\n');
  const blob = new Blob([header+'\n'+body], {type:'text/csv'});
  triggerDownload(blob, filename);
}
function triggerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
}

// ----- Manage defaults modal (add/remove list items) -----
const modal = $('manageModal'), body = $('manageBody');
$('btnManage').addEventListener('click', ()=> { buildManageUI(); modal.style.display='flex'; });
$('closeManage').addEventListener('click', ()=> modal.style.display='none');
$('saveManage').addEventListener('click', ()=> {
  // read chips back
  const fields = ['places','vehicleTypes','service_tax_payable_by','insurance_status','weight_unit','freight_status','copy_type'];
  fields.forEach(f=>{
    const items = Array.from(body.querySelectorAll(`.items[data-key="${f}"] .chip span.val`)).map(el => el.textContent.trim()).filter(Boolean);
    Lists[f] = items.length ? items : Lists[f];
  });
  // update Defaults from selects under each row (if any)
  Defaults.service_tax_payable_by = getDefaultSel('service_tax_payable_by');
  Defaults.insurance_status = getDefaultSel('insurance_status');
  Defaults.weight_unit = getDefaultSel('weight_unit');
  Defaults.freight_status = getDefaultSel('freight_status');
  Defaults.copy_type = getDefaultSel('copy_type');
  // Note: vehicle_type, places default handled by main form fields
  store.set(LISTS_KEY, Lists);
  store.set(DEFAULTS_KEY, Defaults);
  renderLists(); applyDefaults(); modal.style.display='none'; toast('Saved defaults & lists');
});
function getDefaultSel(key){ const sel = body.querySelector(`select[data-def="${key}"]`); return sel ? sel.value : Defaults[key]; }

function buildManageUI(){
  const rows = [
    { key:'places', label:'Places (From/To)', hint:'Add common city/route names' },
    { key:'vehicleTypes', label:'Vehicle Types', hint:'E.g., Open Truck, Container, Trailer' },
    { key:'service_tax_payable_by', label:'Service Tax Payable By', hint:'Who pays service tax?', selectDefault:true },
    { key:'insurance_status', label:'Insurance Status', hint:'Insured / Not Insured', selectDefault:true },
    { key:'weight_unit', label:'Weight Units', hint:'kg / tonne / g', selectDefault:true },
    { key:'freight_status', label:'Freight Status', hint:'TBB / PAID / TO PAY', selectDefault:true },
    { key:'copy_type', label:'Copy Types', hint:'Consignee / Carrier / Accounts / Office', selectDefault:true }
  ];
  body.innerHTML = '';
  rows.forEach(row=>{
    const div = document.createElement('div'); div.className='row';
    const items = Lists[row.key] || [];
    const chips = items.map(v => chipHTML(v)).join('');
    const selectDef = row.selectDefault ? `<select data-def="${row.key}">${items.map(v=>`<option>${escapeHTML(v)}</option>`).join('')}</select>` : '';
    div.innerHTML = `
      <div><strong>${row.label}</strong><div class="inline-note">${row.hint}</div></div>
      <div class="items" data-key="${row.key}">${chips}</div>
      <div style="display:flex;gap:6px;align-items:center">
        <input placeholder="Add ${row.label}" data-add="${row.key}" />
        <button class="btn" data-addbtn="${row.key}">Add</button>
        ${selectDef}
      </div>`;
    body.appendChild(div);
  });

  // Wire add/remove
  body.querySelectorAll('[data-addbtn]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.addbtn;
      const input = body.querySelector(`[data-add="${key}"]`);
      const val = input.value.trim();
      if(!val) return;
      const itemsDiv = body.querySelector(`.items[data-key="${key}"]`);
      itemsDiv.insertAdjacentHTML('beforeend', chipHTML(val));
      input.value='';
      // update default select if present
      const sel = body.querySelector(`select[data-def="${key}"]`);
      if(sel){ sel.insertAdjacentHTML('beforeend', `<option>${escapeHTML(val)}</option>`); }
    });
  });
  body.querySelectorAll('.items').forEach(items=>{
    items.addEventListener('click', (e)=>{
      if(e.target.classList.contains('x')){ e.target.parentElement.remove(); }
    });
  });
}
function chipHTML(v){ return `<span class="chip"><span class="val">${escapeHTML(v)}</span><span class="x" title="Remove">✕</span></span>`; }

// Quick “＋ Add” next to inputs (places / vehicleTypes)
document.querySelectorAll('.add').forEach(el=>{
  el.addEventListener('click', ()=>{
    const target = el.dataset.target;
    const val = prompt('Add new option:');
    if(!val) return;
    if(!Lists[target].includes(val)) Lists[target].push(val);
    store.set(LISTS_KEY, Lists);
    renderLists();
    toast('Added: ' + val);
  });
});

// ----- Print -----
$('btnPrint').addEventListener('click', ()=> window.print());
$('btnPrint2').addEventListener('click', ()=> window.print());

// ----- Buttons -----
$('btnNew').addEventListener('click', newLR);
$('btnSave').addEventListener('click', saveLR);
$('btnPreview').addEventListener('click', updatePreview);
$('btnDelete').addEventListener('click', deleteLR);

// ----- Export via topbar also bound above -----

// ----- Small toast -----
function toast(msg){
  const div = document.createElement('div');
  div.textContent = msg; 
  div.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:.95;z-index:1000';
  document.body.appendChild(div);
  setTimeout(()=>div.remove(), 1800);
}

// ----- Init -----
renderLists();
applyDefaults();
renderTable();
newLR();
updatePreview();

</script>
</body>
</html>
